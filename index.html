<!DOCTYPE html>
<html lang="en">
  <head>
    <title>3D geoJSON</title>
    <!--FIX THE DANG IMPORT FROM GITHUB-->
    <script src="render.js"></script>
    <script src="https://unpkg.com/delaunator@5.0.0/delaunator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.10/lib/p5.min.js"></script>
    
    
    <style>
      * {
        font-family:Verdana, Geneva, Tahoma, sans-serif
      }
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      canvas {
        display: block;
      }
      header {
        height: 100px;
      }
      h1 {
        text-align:center;
      }
      input  {

      }
      button {
        pointer-events:all;
      }
      input:placeholder-shown + button{
        filter:grayscale(1);
        opacity:0.7;
        /*pointer-events:none;*/
      }
      button, input::file-selector-button {
        background-color:rgb(100, 129, 224);
        border:3px rgb(61, 63, 190) solid;
        border-radius:7px;
        padding:5px;
        padding-left:20px;
        padding-right:20px;
        font-size:12pt;
      }
    </style>
    <script>
        
        let coordinates = [];
        let angle = 45;
        let time = Date.now();
        function preload() {
          jsonData = loadJSON("sampleTerrain.json");
        }
        function load() {
          //alert("Loading file..."); USE DOM INSTEAD
          const fileInput = document.getElementById('fileInput');
          const file = fileInput.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              try {
                jsonData = JSON.parse(e.target.result);
                 // Clear previous coordinates
                let map = geoJsonModule.calcTriangles(jsonData);
                mapCoordinates = map[0];
                mapSize = map[1];
                angle = 45;
              } catch (error) {
                console.error("Error parsing JSON:", error);
              }
            };
            reader.readAsText(file);
          } else {
            alert("Please select a file first.");
          }
        }
        function setup() {
          createCanvas(window.innerWidth, window.innerHeight-100, WEBGL);
          frameRate(5);
          let map = geoJsonModule.calcTriangles(jsonData);
          mapCoordinates = map[0];
          mapSize = map[1];

          console.log(Date.now()-time);
        }
              
        function keyPressed() {
          if (keyCode === LEFT_ARROW) {
            angle-=30;
            if(angle<=0) angle = angle+360;
            geoJsonModule.renderGeoJson(mapCoordinates, mapSize);
            return false;
          } else if (keyCode === RIGHT_ARROW) {
            angle+=30;
            if(angle>=360) angle = angle-360;
            geoJsonModule.renderGeoJson(mapCoordinates, mapSize);
            return false;
          }
          
        }
        function windowResized() {
          resizeCanvas(window.innerWidth, window.innerHeight - 100);

          // Recalculate scaling factors
          let scaleX = width / (mapSize.maxX - mapSize.minX);
          let scaleY = height / (mapSize.maxY - mapSize.minY);
          mapSize.scaleZ = 200 / (mapSize.maxZ - mapSize.minZ);
          mapSize.scale = min(scaleX, scaleY) * 1; // Use 90% of the screen

          // Recalculate translation offsets
          mapSize.offsetX = width / 2 - ((mapSize.minX + mapSize.maxX) / 2) * mapSize.scale;
          mapSize.offsetY = height / 2 - ((mapSize.minY + mapSize.maxY) / 2) * mapSize.scale;

          // Re-render the model
          geoJsonModule.renderGeoJson(mapCoordinates, mapSize);
        }
        function draw() {
        }
        
    </script>
  </head>

  <body>
    <header>
      <h1>3D GeoJSON Renderer</h1>
      <input required placeholder="Please select a geoJSON file" type="file" id="fileInput" accept=".json"/>
      <button onclick="load()">Load Sketch</button>
    </header>
  </body>
</html>
